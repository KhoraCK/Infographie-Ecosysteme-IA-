# ===========================================
# WIBOT - Docker Compose
# ===========================================
# Backend FastAPI + PostgreSQL + Nginx
# Usage: docker-compose up -d

services:
  # ===========================================
  # PostgreSQL avec pgvector
  # ===========================================
  postgres:
    image: pgvector/pgvector:pg14
    container_name: wibot-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-wibot}
      POSTGRES_USER: ${POSTGRES_USER:-widip}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-widip_secure_password_2024}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./wibot-backend/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U widip -d wibot"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - wibot-network
    restart: unless-stopped

  # ===========================================
  # Backend FastAPI
  # ===========================================
  backend:
    build:
      context: ./wibot-backend
      dockerfile: Dockerfile
    container_name: wibot-backend
    environment:
      - DATABASE_URL=postgresql://widip:widip_secure_password_2024@postgres:5432/wibot
      - JWT_SECRET=wibot_jwt_secret_key_minimum_32_chars_2024
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRATION_HOURS=24
      - MISTRAL_API_KEY=zflcSXGX1MITX2gP32EC7oD8FlXYRzcN
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:8080","http://localhost:3000"]
      - DEFAULT_QUOTA_TOKENS=500000
      - MAX_FILE_SIZE_MB=20
      # MCP Server Configuration
      - MCP_SERVER_URL=http://mcp-server:3001
      - MCP_TIMEOUT=300
      - MCP_MAX_RETRIES=3
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      mcp-server:
        condition: service_started
    volumes:
      - ./rag-documents:/app/rag-documents
      - ./uploads:/app/uploads
    command: uvicorn main:app --host 0.0.0.0 --port 8000
    networks:
      - wibot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================
  # MCP Server - WIDIP MCP Server v2.0
  # ===========================================
  mcp-server:
    build:
      context: ./02_MCP_SERVER
      dockerfile: Dockerfile
    container_name: wibot-mcp-server
    environment:
      # Server
      - MCP_SERVER_HOST=0.0.0.0
      - MCP_SERVER_PORT=3001
      - MCP_SERVER_DEBUG=${MCP_SERVER_DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Security (SAFEGUARD) - Desactive pour dev
      - MCP_API_KEY=${MCP_API_KEY:-wibot_mcp_dev_key}
      - MCP_REQUIRE_AUTH=${MCP_REQUIRE_AUTH:-false}
      - CORS_ALLOWED_ORIGINS=http://localhost:5173,http://localhost:8080,http://localhost:8000
      - SAFEGUARD_ENABLED=${SAFEGUARD_ENABLED:-true}
      # GLPI (Test) - Pas d'App-Token requis
      - GLPI_URL=https://supporttest.widip.fr/apirest.php
      - GLPI_APP_TOKEN=
      - GLPI_USER_TOKEN=fTsYu4LPs42PxLP63sKdEZ4uXXR7VlLppNtnnz3a
      # Observium (PROD - LECTURE SEULE)
      - OBSERVIUM_URL=https://observium.widip.fr/api/v0
      - OBSERVIUM_USER=mripouteau
      - OBSERVIUM_PASS=*Jesuisunsuperherode1996
      # LDAP/AD (a configurer via connecteurs)
      - LDAP_SERVER=${LDAP_SERVER:-}
      - LDAP_USE_SSL=${LDAP_USE_SSL:-false}
      - LDAP_BASE_DN=${LDAP_BASE_DN:-}
      - LDAP_BIND_USER=${LDAP_BIND_USER:-}
      - LDAP_BIND_PASS=${LDAP_BIND_PASS:-}
      # SMTP (a configurer via connecteurs)
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USE_TLS=${SMTP_USE_TLS:-true}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      # MySecret (a configurer via connecteurs)
      - MYSECRET_URL=${MYSECRET_URL:-}
      - MYSECRET_API_KEY=${MYSECRET_API_KEY:-}
      # PostgreSQL (partage avec WIBOT)
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=widip
      - POSTGRES_PASS=widip_secure_password_2024
      - POSTGRES_DB=wibot
    ports:
      - "3001:3001"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - wibot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 45s

  # ===========================================
  # Frontend React (build + serve)
  # ===========================================
  frontend:
    build:
      context: ./wibot-frontend
      dockerfile: Dockerfile
    container_name: wibot-frontend
    networks:
      - wibot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ===========================================
  # Nginx - Reverse Proxy
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: wibot-nginx
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
      - frontend
    networks:
      - wibot-network
    restart: unless-stopped

volumes:
  postgres_data:

networks:
  wibot-network:
    driver: bridge
